<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∏–Ω–Ω–∞—è –≥–∞–ª–µ—Ä–µ—è</title>
    <style>
        /* ================================================= */
        /* === –°–¢–ò–õ–ò: –¢–ï–ú–ù–´–ô –§–û–ù –ò –ü–ê–†–ê–õ–õ–ê–ö–° === */
        /* ================================================= */

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #1a1a2e; 
            min-height: 200vh;
            padding: 20px;
            color: #f4f4f4; 
            position: relative;
            overflow-x: hidden;
            transition: background-color 0.5s;
        }
        
        .parallax-item {
            position: absolute;
            font-size: 8em; 
            opacity: 0.25; 
            z-index: -1;
            will-change: transform;
            color: #4a4a7e; 
            text-shadow: 0 0 10px rgba(74, 74, 126, 0.5);
        }
        .brush1 { top: 20vh; left: 10vw; }
        .brush1::before { content: 'üñåÔ∏è'; }
        .paint-tube { top: 60vh; right: 15vw; }
        .paint-tube::before { content: 'üåå'; } 
        .brush2 { top: 120vh; left: 20vw; }
        .brush2::before { content: '‚ú®'; }
        .star { top: 150vh; right: 5vw; font-size: 5em; opacity: 0.15; }
        .star::before { content: '‚≠ê'; }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
            color: #f4f4f4;
            position: relative;
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4); 
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .stats {
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 8px;
            padding: 10px 20px;
            display: inline-block;
            font-size: 1em;
        }

        .user-panel {
            position: absolute;
            top: 0;
            right: 0;
            display: flex;
            gap: 10px;
            align-items: center;
            font-size: 0.9em;
        }

        .user-info {
            color: #f4f4f4;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        .btn-green { background: #3498db; }
        .btn:hover { opacity: 0.9; }

        .pictures-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 30px;
            perspective: 1000px;
        }

        .picture-card {
            background: #33395d; 
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            transition: transform 0.1s;
            transform-style: preserve-3d;
        }
        
        .picture-image-wrapper {
            width: 100%;
            height: 200px;
            background-color: #2b2b4a; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            cursor: pointer;
            transform: translateZ(5px);
        }

        .picture-card img {
            width: 100%;
            height: 100%;
            object-fit: contain; 
            display: block;
        }


        .picture-info {
            padding: 15px;
            transform: translateZ(20px);
            color: #f4f4f4;
        }

        .picture-info h2 {
            font-size: 1.5em;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .picture-info p {
            font-size: 0.9em;
            line-height: 1.6;
            margin-bottom: 5px;
        }

        .price {
            font-weight: bold;
            color: #2ecc71; 
            margin-top: 10px;
            font-size: 1.1em;
        }

        .owner-name {
            font-size: 0.85em;
            color: #bdc3c7;
            margin-bottom: 10px;
        }
        
        .error { color: #e74c3c; }

        /* ================================================= */
        /* === –°–¢–ò–õ–ò –î–õ–Ø 3D-–õ–ê–ô–¢–ë–û–ö–°–ê === */
        /* ================================================= */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            padding-top: 60px;
        }
        #image-viewer-modal {
            background-color: rgba(0,0,0,0.95); 
            padding: 0;
            align-items: center;
            justify-content: center;
            padding-top: 0; /* –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
        }
        
        .image-viewer-content {
            margin: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 90%;
            height: 90%;
            max-width: 900px;
            max-height: 900px;
            perspective: 1500px; 
            transform-style: preserve-3d;
            cursor: grab; /* –ö—É—Ä—Å–æ—Ä –¥–ª—è 3D-–≤—Ä–∞—â–µ–Ω–∏—è */
        }
        .image-viewer-content:active {
            cursor: grabbing;
        }
        
        #viewer-img {
            width: 100%;
            height: auto;
            max-height: 100%;
            display: block;
            object-fit: contain;
            transform: none; 
            transition: transform 0.1s ease-out;
            box-shadow: 0 0 50px rgba(0, 0, 0, 0.9);
            background: #111;
        }
        
        .image-viewer-controls {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(5px);
        }
        .image-viewer-controls button {
            background: #fff;
            color: #333;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.1em;
            transition: background 0.3s;
        }
        .image-viewer-controls button:hover {
            background: #3498db;
            color: #fff;
        }
        .control-tip {
            color: #ecf0f1;
            font-size: 0.9em;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 15px;
            border-radius: 5px;
            margin-right: 15px;
            display: flex;
            align-items: center;
        }
        .close-viewer {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .modal-content {
            /* ... (–¥–ª—è —Ñ–æ—Ä–º) */
            background-color: #2c3e50; 
            color: #f4f4f4;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 400px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.6);
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    
    <div class="parallax-bg">
        <div class="parallax-item brush1"></div>
        <div class="parallax-item paint-tube"></div>
        <div class="parallax-item star"></div>
        <div class="parallax-item brush2"></div>
    </div>

    <div class="container">
        <header>
            <h1>Art Gallery üñºÔ∏è</h1>
            <p class="subtitle">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –Ω–∞—à—É –≥–∞–ª–µ—Ä–µ—é —Ü–∏—Ñ—Ä–æ–≤—ã—Ö –∫–∞—Ä—Ç–∏–Ω</p>
            <div class="stats">
                –í—Å–µ–≥–æ –∫–∞—Ä—Ç–∏–Ω: <span id="picture-count">0</span>
            </div>
            
            <div class="user-panel">
                <span id="user-display" class="user-info" style="display: none;"></span>
                <button id="login-btn" class="btn btn-green">–í—Ö–æ–¥</button>
                <button id="register-btn" class="btn btn-green">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
                <button id="add-picture-btn" class="btn btn-green" style="display: none;">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É</button>
                <button id="logout-btn" class="btn" style="display: none;">–í—ã—Ö–æ–¥</button>
            </div>
        </header>

        <main id="pictures-container" class="pictures-grid">
            <h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω...</h2>
        </main>
        
        <div id="message-container"></div>
    </div>

    <div id="modal" class="modal">
        <div id="modal-content" class="modal-content">
            </div>
    </div>
    
    <div id="image-viewer-modal" class="modal">
        <span class="close-viewer" id="close-viewer-btn">&times;</span>
        <div id="image-viewer-content" class="image-viewer-content">
            <img id="viewer-img" src="" alt="Full size image">
        </div>
        <div class="image-viewer-controls">
            <span class="control-tip">–ö—Ä—É—Ç–∏—Ç–µ –º—ã—à—å—é, –ó—É–º:</span>
            <button id="zoom-in-btn" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å –ø–æ Z">+</button>
            <button id="zoom-out-btn" title="–û—Ç–¥–∞–ª–∏—Ç—å –ø–æ Z">-</button>
            <button id="rotate-z-left-btn" title="–ü–æ–≤–æ—Ä–æ—Ç –≤–ª–µ–≤–æ">‚Ü∫</button>
            <button id="rotate-z-right-btn" title="–ü–æ–≤–æ—Ä–æ—Ç –≤–ø—Ä–∞–≤–æ">‚Üª</button>
        </div>
    </div>


<script>
    let sessionInfo = null;
    let currentUser = null;
    let currentRole = 'guest';

    // === JS –î–õ–Ø –ü–ê–†–ê–õ–õ–ê–ö–°–ê –§–û–ù–ê ===
    const p_brush1 = document.querySelector('.brush1');
    const p_paintTube = document.querySelector('.paint-tube');
    const p_brush2 = document.querySelector('.brush2');
    const p_star = document.querySelector('.star');

    window.addEventListener('scroll', () => {
        const scrollY = window.scrollY;
        if (p_brush1) p_brush1.style.transform = `translateY(${scrollY * 0.2}px)`;
        if (p_paintTube) p_paintTube.style.transform = `translateY(${scrollY * 0.5}px) rotate(15deg)`;
        if (p_brush2) p_brush2.style.transform = `translateY(${scrollY * 0.3}px)`;
        if (p_star) p_star.style.transform = `translateY(${scrollY * 0.1}px)`;
    });
    
    // =================================================
    // === JS –î–õ–Ø –ò–ú–ú–ï–†–°–ò–í–ù–û–ì–û 3D-–õ–ê–ô–¢–ë–û–ö–°–ê (–ú—ã—à—å) ===
    // =================================================
    const imageViewerModal = document.getElementById('image-viewer-modal');
    const viewerContent = document.getElementById('image-viewer-content');
    const viewerImg = document.getElementById('viewer-img');
    const closeViewerBtn = document.getElementById('close-viewer-btn');

    let currentZoom = 1;
    let currentRotationX = 0;
    let currentRotationY = 0;
    let currentRotationZ = 0;
    let currentTranslateZ = 0; 

    let isDragging = false;
    let startX, startY;
    let rotationSensitivity = 0.5;

    function updateTransform() {
        viewerImg.style.transform = 
            `translateZ(${currentTranslateZ}px) 
             scale(${currentZoom}) 
             rotateX(${currentRotationX}deg) 
             rotateY(${currentRotationY}deg) 
             rotateZ(${currentRotationZ}deg)`;
    }

    function openImageViewer(src) {
        viewerImg.src = src;
        currentZoom = 1;
        currentRotationX = 0;
        currentRotationY = 0;
        currentRotationZ = 0;
        currentTranslateZ = 0; 
        updateTransform();
        imageViewerModal.style.display = 'flex'; 
    }

    function closeImageViewer() {
        imageViewerModal.style.display = 'none';
        viewerImg.src = '';
    }

    // === –£–ü–†–ê–í–õ–ï–ù–ò–ï –ú–´–®–¨–Æ (3D –≤—Ä–∞—â–µ–Ω–∏–µ) ===
    viewerContent.addEventListener('mousedown', (e) => {
        // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ –∫–ª–∏–∫ –Ω–µ –±—ã–ª –Ω–∞ —ç–ª–µ–º–µ–Ω—Ç–∞—Ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–Ω–∏–∑—É
        if (e.target.closest('.image-viewer-controls')) return; 
        
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        viewerContent.style.cursor = 'grabbing';
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ mousemove –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –Ω–∞ –≤—Å–µ–º –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ, —á—Ç–æ–±—ã –Ω–µ —Ç–µ—Ä—è—Ç—å –∑–∞—Ö–≤–∞—Ç
    imageViewerModal.addEventListener('mousemove', (e) => {
        if (!isDragging) return;

        const deltaX = e.clientX - startX;
        const deltaY = e.clientY - startY;

        // –ü–æ –æ—Å–∏ Y (–≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏) –≤—Ä–∞—â–∞–µ–º –ø–æ X
        currentRotationX -= deltaY * rotationSensitivity * 0.1;
        // –ü–æ –æ—Å–∏ X (–≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –º—ã—à–∏) –≤—Ä–∞—â–∞–µ–º –ø–æ Y
        currentRotationY += deltaX * rotationSensitivity * 0.1;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –∏–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª—å
        currentRotationX = Math.max(-90, Math.min(90, currentRotationX));

        updateTransform();
        
        startX = e.clientX;
        startY = e.clientY;
    });

    imageViewerModal.addEventListener('mouseup', () => {
        isDragging = false;
        viewerContent.style.cursor = 'grab';
    });

    imageViewerModal.addEventListener('mouseleave', () => {
        isDragging = false;
        viewerContent.style.cursor = 'grab';
    });


    // –°–ª—É—à–∞—Ç–µ–ª–∏ –¥–ª—è Zoom –∏ Z-Rotation
    closeViewerBtn.addEventListener('click', closeImageViewer);
    
    document.getElementById('zoom-in-btn').addEventListener('click', () => {
        currentZoom = Math.min(currentZoom + 0.1, 3);
        currentTranslateZ += 50; 
        updateTransform();
    });
    
    document.getElementById('zoom-out-btn').addEventListener('click', () => {
        currentZoom = Math.max(currentZoom - 0.1, 0.5);
        currentTranslateZ -= 50;
        updateTransform();
    });
    
    document.getElementById('rotate-z-left-btn').addEventListener('click', () => {
        currentRotationZ -= 90;
        updateTransform();
    });
    document.getElementById('rotate-z-right-btn').addEventListener('click', () => {
        currentRotationZ += 90;
        updateTransform();
    });
    
    imageViewerModal.addEventListener('click', function(event) {
        if (event.target === this) {
            closeImageViewer();
        }
    });
    // --- –ö–æ–Ω–µ—Ü 3D-–õ–ê–ô–¢–ë–û–ö–°–ê ---


    document.addEventListener('DOMContentLoaded', () => {
        loadPictures();
        checkLoginStatus();
        setupEventListeners();
    });

    // === –£–¢–ò–õ–ò–¢–´ ===
    function showMessage(type, message) {
        const container = document.getElementById('message-container');
        const alert = document.createElement('div');
        alert.classList.add('alert', type);
        alert.textContent = message;
        container.innerHTML = '';
        container.appendChild(alert);
        setTimeout(() => alert.remove(), 5000);
    }
    function showError(message) { showMessage('error', message); }
    function showSuccess(message) { showMessage('success', message); }
    function escapeHtml(text) {
        if (typeof text !== 'string') return text;
        return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }
    
    // –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –¶–ï–ù–´ –° –ü–†–û–í–ï–†–ö–û–ô
    function formatPrice(price) {
        if (typeof price === 'number' && !isNaN(price) && price >= 0) {
            return price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
        return 'N/A';
    }

    // === –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–§–æ—Ä–º—ã) ===
    function openModal(contentHtml) { 
        document.getElementById('modal-content').innerHTML = contentHtml;
        document.getElementById('modal').style.display = 'block';
    }
    function closeModal() { 
        document.getElementById('modal').style.display = 'none';
        document.getElementById('modal-content').innerHTML = '';
    }
    document.getElementById('modal').addEventListener('click', function(event) { 
        if (event.target === this) closeModal();
    });

    // === –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–Ø –ò –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø (–ó–∞–≥–ª—É—à–∫–∏, –Ω—É–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å) ===
    async function fetchSession() {
        try {
            const response = await fetch('/api/auth/session');
            if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–µ—Å—Å–∏–∏');
            return await response.json();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Å—Å–∏–∏:', error);
            return { isAuthenticated: false };
        }
    }
    async function checkLoginStatus() {
        sessionInfo = await fetchSession();
        updateUIForLoginState();
    }
    function updateUIForUser(session) {
        document.getElementById('user-display').textContent = `–ü—Ä–∏–≤–µ—Ç, ${session.username} (${session.role})`;
        document.getElementById('user-display').style.display = 'inline';
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('register-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'inline';
        document.getElementById('add-picture-btn').style.display = 'inline';
    }
    function updateUIForGuest() {
        document.getElementById('user-display').style.display = 'none';
        document.getElementById('login-btn').style.display = 'inline';
        document.getElementById('register-btn').style.display = 'inline';
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('add-picture-btn').style.display = 'none';
    }
    function updateUIForLoginState() {
        if (sessionInfo && sessionInfo.isAuthenticated) {
            updateUIForUser(sessionInfo);
        } else {
            updateUIForGuest();
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤–∏–¥–∏–º–æ—Å—Ç—å –∫–Ω–æ–ø–æ–∫ "–£–¥–∞–ª–∏—Ç—å" –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏/–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        document.querySelectorAll('.picture-card').forEach(card => {
            const deleteBtn = card.querySelector('.delete-btn');
            if (deleteBtn) {
                const pictureId = deleteBtn.dataset.pictureId;
                const pictureData = currentPictures.find(p => p._id === pictureId);
                
                const isOwner = sessionInfo && pictureData && pictureData.userId && typeof pictureData.userId === 'object' && (sessionInfo.userId === pictureData.userId._id);
                const isAdmin = sessionInfo && sessionInfo.role === 'admin';
                
                if (isOwner || isAdmin) {
                    deleteBtn.style.display = 'block';
                } else {
                    deleteBtn.style.display = 'none';
                }
            }
        });
    }
    async function handleAuth(event, endpoint) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            closeModal();
            if (response.ok) {
                showSuccess(`–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${result.username}!`);
                sessionInfo = { isAuthenticated: true, userId: result.id, username: result.username, role: result.role };
                updateUIForLoginState();
                loadPictures(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å"
            } else {
                showError(result.error || '–û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Å–µ—Ä–≤–µ—Ä–∞:', error);
            closeModal();
            showError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º.');
        }
    }


    // === –ö–ê–†–¢–ò–ù–´ (CRUD) ===
    let currentPictures = [];

    async function loadPictures() {
        try {
            sessionInfo = await fetchSession(); 
            
            const picturesContainer = document.getElementById('pictures-container');
            picturesContainer.innerHTML = '<h2>–ó–∞–≥—Ä—É–∑–∫–∞ –∫–∞—Ä—Ç–∏–Ω...</h2>';

            const response = await fetch('/api/pictures'); 
            if (!response.ok) {
                throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ –∫–∞—Ä—Ç–∏–Ω–∞—Ö.');
            }

            currentPictures = await response.json(); // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –ª–æ–≥–∏–∫–∏ —É–¥–∞–ª–µ–Ω–∏—è
            
            picturesContainer.innerHTML = '';
            document.getElementById('picture-count').textContent = currentPictures.length;
            
            if (currentPictures.length === 0) {
                picturesContainer.innerHTML = '<p>–ü–æ–∫–∞ –Ω–µ—Ç –∫–∞—Ä—Ç–∏–Ω –≤ –≥–∞–ª–µ—Ä–µ–µ.</p>';
            } else {
                currentPictures.forEach(picture => {
                    picturesContainer.appendChild(displayPicture(picture)); 
                });
            }
            
            applyTiltEffect();
            
            updateUIForLoginState(); 
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞—Ä—Ç–∏–Ω:', error);
            document.getElementById('pictures-container').innerHTML = '<p class="error">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö.</p>';
            updateUIForLoginState(); 
        }
    }


    // ‚ö†Ô∏è –§–ò–ö–°: –ù–∞–¥–µ–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤—Å–µ—Ö –ø–æ–ª–µ–π, –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞—é—â–∞—è undefined
    function displayPicture(picture) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–º–µ—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª–µ–π
        const title = escapeHtml(picture.title ?? '–ù–µ—Ç –Ω–∞–∑–≤–∞–Ω–∏—è');
        const artist = escapeHtml(picture.artist ?? '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π');
        const year = picture.year ?? 'N/A';
        const style = escapeHtml(picture.style ?? '–ù–µ —É–∫–∞–∑–∞–Ω');
        const priceValue = picture.price ?? 'N/A';
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è –∏–º–µ–Ω–∏ –≤–ª–∞–¥–µ–ª—å—Ü–∞
        const ownerName = (
            picture.userId && 
            typeof picture.userId === 'object' && 
            picture.userId.username
        ) 
            ? escapeHtml(picture.userId.username) 
            : '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä/–°–∏—Å—Ç–µ–º–∞';
        
        const cardDiv = document.createElement('div');
        cardDiv.classList.add('picture-card');
        cardDiv.setAttribute('data-id', picture._id); 

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
        cardDiv.innerHTML = `
            <div class="picture-image-wrapper">
                <img src="${escapeHtml(picture.imageUrl ?? '')}" alt="${title}">
            </div>
            <div class="picture-info">
                <h2>${title}</h2>
                <p><strong>–•—É–¥–æ–∂–Ω–∏–∫:</strong> ${artist} (${year})</p>
                <p><strong>–°—Ç–∏–ª—å:</strong> ${style}</p>
                <p class="price">–¶–µ–Ω–∞: ${priceValue === 'N/A' ? '–¶–µ–Ω–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞' : formatPrice(priceValue) + ' ‚ÇΩ'}</p>
                
                <p class="owner-name">
                    –í–ª–∞–¥–µ–ª–µ—Ü: <strong>${ownerName}</strong>
                </p>
                
                <button 
                    class="delete-btn" 
                    data-picture-id="${picture._id}" 
                    title="–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É"
                    style="display: none;" 
                >
                    –£–¥–∞–ª–∏—Ç—å
                </button>
            </div>
        `;

        // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –ª–∞–π—Ç–±–æ–∫—Å–∞ (–Ω–∞ –æ–±–µ—Ä—Ç–∫—É –∫–∞—Ä—Ç–∏–Ω–∫–∏)
        const imgWrapper = cardDiv.querySelector('.picture-image-wrapper');
        // ‚ö†Ô∏è –ö–ê–†–¢–ò–ù–ê –ù–ï –û–¢–ö–†–´–í–ê–õ–ê–°–¨, –¢.–ö. –î–û –≠–¢–û–ì–û –ú–û–ú–ï–ù–¢–ê –í–´–°–ö–ê–ö–ò–í–ê–õ–ê –û–®–ò–ë–ö–ê
        // –¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –¥–∞–Ω–Ω—ã–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã, —ç—Ç–æ—Ç —Å–ª—É—à–∞—Ç–µ–ª—å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
        imgWrapper.addEventListener('click', () => {
            if (picture.imageUrl) {
                openImageViewer(picture.imageUrl);
            } else {
                showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç URL.');
            }
        });

        // --- –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–£–¥–∞–ª–∏—Ç—å" ---
        const deleteBtn = cardDiv.querySelector('.delete-btn');
        deleteBtn.addEventListener('click', (event) => {
            event.stopPropagation();
            if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç–∏–Ω—É "${title}"?`)) {
                deletePicture(picture._id);
            }
        });

        return cardDiv;
    }

    async function deletePicture(pictureId) {
        try {
            const response = await fetch(`/api/pictures/${pictureId}`, { method: 'DELETE' });
            const data = await response.json();
            if (response.ok) {
                showSuccess(data.message);
                loadPictures();
            } else {
                showError(data.error || '–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω—ã');
            }
        } catch (error) {
            showError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏.');
        }
    }
    
    async function handleAddPicture(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
        data.year = parseInt(data.year);
        data.price = parseFloat(data.price);

        try {
            const response = await fetch('/api/pictures', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            closeModal();
            if (response.ok) {
                showSuccess(`–ö–∞—Ä—Ç–∏–Ω–∞ "${result.title}" —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞.`);
                loadPictures();
            } else {
                showError(result.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç–∏–Ω—ã');
            }
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è:', error);
            closeModal();
            showError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏.');
        }
    }


    // JS –¥–ª—è 3D-—ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–∞–∫–ª–æ–Ω–∞ –ø—Ä–µ–≤—å—é (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
    function applyTiltEffect() {
        const cards = document.querySelectorAll('.picture-card');
        
        cards.forEach(card => {
            card.addEventListener('mousemove', (e) => {
                const rect = card.getBoundingClientRect();
                const x = e.clientX - rect.left - rect.width / 2;
                const y = e.clientY - rect.top - rect.height / 2;
                
                const rotateX = -y / 20; 
                const rotateY = x / 20;
                
                card.style.transform = `rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.03)`;
            });
            
            card.addEventListener('mouseleave', () => {
                card.style.transform = 'rotateX(0deg) rotateY(0deg) scale(1)';
            });
        });
    }


    // === –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ===
    function setupEventListeners() {
        document.getElementById('login-btn').addEventListener('click', () => {
            const html = `
                <h2>–í—Ö–æ–¥</h2>
                <form id="login-form">
                    <div class="form-group"><label>–õ–æ–≥–∏–Ω:</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>–ü–∞—Ä–æ–ª—å:</label><input type="password" name="password" required></div>
                    <button type="submit" class="btn btn-green" style="width: 100%;">–í–æ–π—Ç–∏</button>
                </form>
                <span class="close" onclick="closeModal()">&times;</span>
            `;
            openModal(html);
            document.getElementById('login-form').addEventListener('submit', (e) => handleAuth(e, '/api/auth/login'));
        });

        document.getElementById('register-btn').addEventListener('click', () => {
            const html = `
                <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <form id="register-form">
                    <div class="form-group"><label>–õ–æ–≥–∏–Ω:</label><input type="text" name="username" required></div>
                    <div class="form-group"><label>–ü–∞—Ä–æ–ª—å:</label><input type="password" name="password" required></div>
                    <input type="hidden" name="role" value="user">
                    <button type="submit" class="btn btn-green" style="width: 100%;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
                </form>
                <span class="close" onclick="closeModal()">&times;</span>
            `;
            openModal(html);
            document.getElementById('register-form').addEventListener('submit', (e) => handleAuth(e, '/api/auth/register'));
        });

        document.getElementById('logout-btn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/auth/logout', { method: 'POST' });
                const data = await response.json();
                if (response.ok) {
                    showSuccess(data.message);
                    sessionInfo = null;
                    loadPictures(); 
                    updateUIForGuest(); 
                } else {
                    showError(data.error || '–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—ã—Ö–æ–¥–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ.');
            }
        });

        document.getElementById('add-picture-btn').addEventListener('click', () => {
            const html = `
                <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∫–∞—Ä—Ç–∏–Ω—É</h2>
                <form id="add-picture-form">
                    <div class="form-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label><input type="text" name="title" required></div>
                    <div class="form-group"><label>–•—É–¥–æ–∂–Ω–∏–∫:</label><input type="text" name="artist" required></div>
                    <div class="form-group"><label>–ì–æ–¥:</label><input type="number" name="year" min="1" max="2050" required></div>
                    <div class="form-group"><label>URL –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:</label><input type="url" name="imageUrl" required></div>
                    <div class="form-group"><label>–°—Ç–∏–ª—å:</label><input type="text" name="style"></div>
                    <div class="form-group"><label>–¶–µ–Ω–∞ (‚ÇΩ):</label><input type="number" name="price" step="0.01" min="0" required></div>
                    <div class="form-group"><label>–†–∞–∑–º–µ—Ä:</label><input type="text" name="size"></div>
                    <div class="form-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ:</label><textarea name="description"></textarea></div>
                    <button type="submit" class="btn btn-green" style="width: 100%;">–î–æ–±–∞–≤–∏—Ç—å</button>
                </form>
                <span class="close" onclick="closeModal()">&times;</span>
            `;
            openModal(html);
            document.getElementById('add-picture-form').addEventListener('submit', handleAddPicture);
        });
    }
</script>
</body>
</html>